#!/usr/bin/env node
import { Command } from 'commander';
import { dbInit, dbMigrate, dbSeed } from '../src/cli/db.js';
import { fetchKlines } from '../src/cli/fetch.js';
import { computeIndicators } from '../src/cli/compute.js';
import { detectPatterns } from '../src/cli/patterns.js';
import { signalsGenerate } from '../src/cli/signals.js';
import { backtestRun } from '../src/cli/backtest.js';
import { paperEquitySnapshot } from '../src/cli/paper.js';
import { resampleCandles } from '../src/cli/resample.js';
import { jobsList, jobsRun } from '../src/cli/jobs.js';
import logger from '../src/utils/logger.js';

const program = new Command();
program
  .name('cs')
  .description('Crypto Signals CLI')
  .option('--dry-run', 'skip database writes')
  .option('--limit <n>', 'limit number of processed items', (v) => parseInt(v, 10))
  .option('--verbose', 'enable verbose logging');

program.hook('preAction', (thisCommand, actionCommand) => {
  const globalOpts = thisCommand.opts();
  if (globalOpts.verbose) {
    logger.level = 'debug';
  }
  for (const [key, value] of Object.entries(globalOpts)) {
    if (actionCommand.getOptionValue(key) === undefined) {
      actionCommand.setOptionValue(key, value);
    }
  }
});

program.command('db:init').action(dbInit);
program.command('db:migrate').action(dbMigrate);
program.command('db:seed').action(dbSeed);
program
  .command('fetch:klines')
  .requiredOption('--symbol <symbol>')
  .option('--from <ms>')
  .option('--to <ms>')
  .option('--interval <interval>', '1m')
  .option('--fetch-limit <number>', '1000')
  .option('--resume')
  .option('--server-time')
  .action(fetchKlines);
program
  .command('compute:indicators')
  .requiredOption('--symbol <symbol>')
  .requiredOption('--interval <interval>')
  .action((opts) => computeIndicators(opts));
program
  .command('detect:patterns')
  .requiredOption('--symbol <symbol>')
  .requiredOption('--interval <interval>')
  .action((opts) => detectPatterns(opts));
program
  .command('resample')
  .requiredOption('--from <interval>')
  .requiredOption('--to <interval>')
  .requiredOption('--symbol <symbol>')
  .action(resampleCandles);
program
  .command('backtest:run')
  .requiredOption('--strategy <strategy>')
  .requiredOption('--symbol <symbol>')
  .requiredOption('--interval <interval>')
  .requiredOption('--from <from>')
  .requiredOption('--to <to>')
  .requiredOption('--initial <initial>')
  .action(backtestRun);
program
  .command('signals:generate')
  .requiredOption('--symbol <symbol>')
  .requiredOption('--interval <interval>')
  .requiredOption('--strategy <strategy>')
  .action(signalsGenerate);

program
  .command('paper:equity:snapshot')
  .requiredOption('--equity <equity>')
  .requiredOption('--source <source>')
  .action(paperEquitySnapshot);

program
  .command('jobs:list')
  .option('--limit <n>', 'limit number of jobs', (v) => parseInt(v, 10))
  .action(jobsList);

program
  .command('jobs:run')
  .requiredOption('--type <type>')
  .option('--params <json>')
  .action(jobsRun);

program.parseAsync(process.argv);
